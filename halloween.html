function update7TVEmoteSetHalloween() {
  const SET_ID = "01GWQBMP38000EA1CR0A0YQ01Y";
  const SHEET_NAME = "EmotesHalloween";

  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);

  // Header sicherstellen (A–H)
  if (sheet.getLastRow() === 0) {
    sheet.getRange(1, 1, 1, 8).setValues([[
      "emote_id", "emote_name", "image_url", "preview", "tags", "updated_at", "tags_clean", "active"
    ]]);
  } else {
    // Falls "active" noch fehlt, hinzufügen (nur wenn G schon existiert)
    const lastCol = sheet.getLastColumn();
    const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(x => String(x || "").trim());
    if (!headers.includes("active")) {
      sheet.getRange(1, lastCol + 1).setValue("active");
    }
  }

  const lastRow = sheet.getLastRow();
  const now = new Date();

  // Vorhandene IDs -> Zeilennummer (und alle erstmal inactive setzen)
  const existing = new Map();
  if (lastRow >= 2) {
    const ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
    ids.forEach((id, idx) => { if (id) existing.set(String(id), idx + 2); });

    // H = active -> alles auf FALSE setzen
    sheet.getRange(2, 8, lastRow - 1, 1).setValue(false);
  }

  // 7TV Set laden
  const url = `https://7tv.io/v3/emote-sets/${SET_ID}`;
  const res = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
  if (res.getResponseCode() !== 200) {
    throw new Error(`7TV API Fehler (${res.getResponseCode()}): ${res.getContentText()}`);
  }
  const data = JSON.parse(res.getContentText());
  const emotes = data.emotes || data.items || [];

  emotes.forEach((e) => {
    const id = String(e.id);
    const name = e.name;
    const imageUrl = `https://cdn.7tv.app/emote/${id}/4x.webp`;

    if (existing.has(id)) {
      const r = existing.get(id);

      // A–C aktualisieren
      sheet.getRange(r, 1, 1, 3).setValues([[id, name, imageUrl]]);

      // F = updated_at (last_sync)
      sheet.getRange(r, 6).setValue(now);

      // H = active
      sheet.getRange(r, 8).setValue(true);

      // D/E/G unangetastet (preview/tags/tags_clean)
    } else {
      // Neue Zeile
      const newRow = sheet.getLastRow() + 1;

      sheet.getRange(newRow, 1, 1, 8).setValues([[
        id,
        name,
        imageUrl,
        `=IMAGE(C${newRow}; 4; 64; 64)`,
        "",
        now,
        `=REGEXREPLACE(LOWER(E${newRow});"\\s+";"")`,
        true
      ]]);
    }
  });
}
